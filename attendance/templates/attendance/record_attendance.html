{% extends 'accounts/base.html' %}

{% block content %}
<h2>Record Attendance</h2>
<form id="attendance-form" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Registrar Asistencia</button>
</form>

<video id="video" width="320" height="240" autoplay></video>
<canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');

    // Solicitar acceso a la cÃ¡mara
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(err => {
            console.error("Error accessing the camera: ", err);
        });

    document.getElementById('attendance-form').addEventListener('submit', function(event) {
        event.preventDefault();  

        // Capturar el fotograma actual del video
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const frameData = canvas.toDataURL('image/jpeg');

        // Crear un FormData y agregar la imagen capturada
        const formData = new FormData(this);
        formData.append('image', frameData);

        fetch('{% url "record_attendance" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(response => response.json())
        .then(data => {
            const audio = new Audio('ruta/a/tu/sonido.mp3');
            audio.play();  // Reproduce el sonido

            alert(data.message);

            document.getElementById('attendance-form').reset();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
</script>

{% endblock %}
